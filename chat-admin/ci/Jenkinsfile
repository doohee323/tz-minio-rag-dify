pipeline {
    agent {
        kubernetes {
            label 'docker'
            defaultContainer 'docker'
        }
    }
    
    environment {
        GIT_BRANCH = "${env.BRANCH_NAME ?: env.GIT_BRANCH ?: env.CHANGE_BRANCH ?: 'main'}"
        GIT_COMMITTER_EMAIL = "doohee323@gmail.com"

        BUILD_NUMBER = "${env.BUILD_NUMBER ?: 'latest'}"
        DOCKER_NAME = "chat-admin"
        APP_NAME = "chat-admin"
        DEPLOYMENT_NAME = 'chat-admin'
        NAMESPACE = "${(env.BRANCH_NAME ?: env.GIT_BRANCH ?: env.CHANGE_BRANCH ?: 'main').replaceAll('^origin/', '') == 'main' || (env.BRANCH_NAME ?: env.GIT_BRANCH ?: env.CHANGE_BRANCH ?: 'main').replaceAll('^origin/', '') == 'qa' ? 'devops' : 'devops-dev'}"
        NODE_ENV = "development"
        K8S_FILE = "k8s.yaml"

        KUBECTL = "kubectl -n ${NAMESPACE}"
        // Try both possible credential IDs - Jenkins credential ID might be 'my-ubuntu.config' or 'kubeconfig-jenkins'
        KUBECONFIG_CREDENTIALS_ID = 'kubeconfig-jenkins'

        GIT_CREDENTIAL = 'github-token'

        REGISTRY = 'doohee323'
        DOCKERHUB_CREDENTIALS_ID = 'DOCKERHUB_CREDENTIALS_ID'

        // Domain configuration (DOMAIN_PLACEHOLDER = base domain, e.g. drillquiz.com; replaced in k8s manifests as chat.DOMAIN_PLACEHOLDER ‚Üí chat.drillquiz.com)
        BASE_DOMAIN = "${BASE_DOMAIN ?: 'drillquiz.com'}"
        DOMAIN_PLACEHOLDER = "${DOMAIN_PLACEHOLDER ?: 'drillquiz.com'}"
        
        GIT_USERNAME = 'doohee323'
        GIT_REPO_NAME = 'tz-argocd-repo'
    }

    stages {
        stage('Load Credentials') {
            steps {
                script {
                    // Load credentials using withCredentials to ensure proper resolution
                    // Required credentials
                    try {
                        withCredentials([string(credentialsId: 'GITHUB_TOKEN', variable: 'GIT_TOKEN')]) {
                            env.GIT_TOKEN = env.GIT_TOKEN
                        }
                    } catch (Exception e) {
                        echo "‚ö†Ô∏è  GITHUB_TOKEN credential not found, using empty string"
                        env.GIT_TOKEN = ''
                    }

                    try {
                        withCredentials([string(credentialsId: 'DOCKER_PASSWORD', variable: 'DOCKER_PASSWORD')]) {
                            env.DOCKER_PASSWORD = env.DOCKER_PASSWORD
                        }
                    } catch (Exception e) {
                        echo "‚ö†Ô∏è  DOCKER_PASSWORD credential not found, using empty string"
                        env.DOCKER_PASSWORD = ''
                    }

                    // ArgoCD credentials
                    try {
                        withCredentials([string(credentialsId: 'ARGOCD_PASSWORD', variable: 'ARGOCD_PASSWORD')]) {
                            env.ARGOCD_PASSWORD = env.ARGOCD_PASSWORD
                        }
                    } catch (Exception e) {
                        echo "‚ö†Ô∏è  ARGOCD_PASSWORD credential not found, using empty string"
                        env.ARGOCD_PASSWORD = ''
                    }

                    // TZ-Chat Gateway: JWT and Dify API keys
                    try {
                        withCredentials([string(credentialsId: 'CHAT_GATEWAY_JWT_SECRET', variable: 'CHAT_GATEWAY_JWT_SECRET')]) {
                            env.CHAT_GATEWAY_JWT_SECRET = env.CHAT_GATEWAY_JWT_SECRET
                        }
                    } catch (Exception e) {
                        echo "‚ö†Ô∏è  CHAT_GATEWAY_JWT_SECRET credential not found, using empty string"
                        env.CHAT_GATEWAY_JWT_SECRET = ''
                    }
                    try {
                        withCredentials([string(credentialsId: 'CHAT_GATEWAY_API_KEY', variable: 'CHAT_GATEWAY_API_KEY')]) {
                            env.CHAT_GATEWAY_API_KEY = CHAT_GATEWAY_API_KEY
                        }
                    } catch (Exception e) {
                        echo "‚ö†Ô∏è  CHAT_GATEWAY_API_KEY credential not found, using empty string"
                        env.CHAT_GATEWAY_API_KEY = ''
                    }
                    try {
                        withCredentials([string(credentialsId: 'POSTGRES_PASSWORD', variable: 'POSTGRES_PASSWORD')]) {
                            env.POSTGRES_PASSWORD = env.POSTGRES_PASSWORD
                        }
                    } catch (Exception e) {
                        echo "‚ö†Ô∏è  POSTGRES_PASSWORD credential not found, using empty string"
                        env.POSTGRES_PASSWORD = ''
                    }
                    try {
                        withCredentials([string(credentialsId: 'MINIO_ACCESS_KEY', variable: 'MINIO_ACCESS_KEY')]) {
                            env.MINIO_ACCESS_KEY = env.MINIO_ACCESS_KEY
                        }
                    } catch (Exception e) {
                        echo "‚ö†Ô∏è  MINIO_ACCESS_KEY credential not found, using empty string"
                        env.MINIO_ACCESS_KEY = ''
                    }
                    try {
                        withCredentials([string(credentialsId: 'MINIO_SECRET_KEY', variable: 'MINIO_SECRET_KEY')]) {
                            env.MINIO_SECRET_KEY = env.MINIO_SECRET_KEY
                        }
                    } catch (Exception e) {
                        echo "‚ö†Ô∏è  MINIO_SECRET_KEY credential not found, using empty string"
                        env.MINIO_SECRET_KEY = ''
                    }

                    // ArgoCD configuration
                    env.ARGOCD_ID = "tz-admin"
                    env.ARGOCD_SERVER = 'argocd.drillquiz.com'
                    env.ARGOCD_REPO_URL = 'https://github.com/doohee323/tz-argocd-repo.git'
                    env.ARGOCD_ENABLED = "${(env.BRANCH_NAME ?: env.GIT_BRANCH ?: env.CHANGE_BRANCH ?: 'main').replaceAll('^origin/', '') == 'qa' ? 'true' : 'false'}"
                }
            }
        }

        stage('Checkout') {
            steps {
                container('docker') {
                    script {
                        checkout scm
                    }
                }
            }
        }

        stage('Build & Push Image') {
            steps {
                container('docker') {
                    script {
                        try {
                            withDockerRegistry(credentialsId: "${DOCKERHUB_CREDENTIALS_ID}", url: '') {
                                def image = "${REGISTRY}/${DOCKER_NAME}:${BUILD_NUMBER}"
                                sh "docker build -t ${image} ./chat-admin"
                                echo "Pushing image: ${image}"
                                sh "docker push ${image}"
                            }
                        } catch (err) {
                            echo "Docker push failed: ${err}"
                            error("Stopping pipeline due to push failure.")
                        }
                    }
                }
            }
        }

        stage('Deploy to Kubernetes') {
            steps {
                container('kubectl') {
                    script {
                        try {
                            // KUBECONFIG is required for Kubernetes deployment
                            // Use credential ID directly (not via environment variable to avoid resolution issues)
                            try {
                                withCredentials([file(credentialsId: 'kubeconfig-jenkins', variable: 'KUBECONFIG')]) {
                                    echo "‚úÖ Using KUBECONFIG credential: kubeconfig-jenkins"
                                    sh '''
                                        export PATH=$PATH:.:
                                        echo "üîß Installing bash..."
                                        if command -v apk >/dev/null 2>&1; then
                                            echo "üì¶ Using Alpine Linux package manager (apk)..."
                                            apk add --no-cache bash
                                        elif command -v apt-get >/dev/null 2>&1; then
                                            echo "üì¶ Using Debian/Ubuntu package manager (apt-get)..."
                                            apt-get update && apt-get install -y bash
                                        elif command -v yum >/dev/null 2>&1; then
                                            echo "üì¶ Using CentOS/RHEL package manager (yum)..."
                                            yum install -y bash
                                        else
                                            echo "‚ùå No supported package manager found"
                                            exit 1
                                        fi
                                        echo "‚úÖ Bash installation completed"
                                        echo "üîç Checking chat-admin/ci/k8s.sh file..."
                                        ls -la chat-admin/ci/k8s.sh || echo "‚ùå chat-admin/ci/k8s.sh not found"
                                        if [ -f "chat-admin/ci/k8s.sh" ]; then
                                            echo "‚úÖ chat-admin/ci/k8s.sh found, setting permissions..."
                                            chmod +x chat-admin/ci/k8s.sh
                                            echo "üöÄ Starting Kubernetes deployment..."
                                            echo "  BUILD_NUMBER: ${BUILD_NUMBER}"
                                            echo "  GIT_BRANCH: ${GIT_BRANCH}"
                                            echo "  NAMESPACE: ${NAMESPACE}"
                                            echo "  ARGOCD_ENABLED: ${ARGOCD_ENABLED}"
                                            echo "  ARGOCD_SERVER: ${ARGOCD_SERVER}"
                                            echo "  ARGOCD_REPO_URL: ${ARGOCD_REPO_URL}"
                                            echo "  BASE_DOMAIN: ${BASE_DOMAIN}"
                                            echo "  APP_NAME: ${APP_NAME}"
                                            export BASE_DOMAIN=${BASE_DOMAIN}
                                            export DOMAIN_PLACEHOLDER=${DOMAIN_PLACEHOLDER}
                                            export APP_NAME=${APP_NAME}
                                            export CHAT_GATEWAY_JWT_SECRET=${CHAT_GATEWAY_JWT_SECRET}
                                            export CHAT_GATEWAY_API_KEY=${CHAT_GATEWAY_API_KEY}
                                            export POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
                                            export MINIO_ACCESS_KEY=${MINIO_ACCESS_KEY}
                                            export MINIO_SECRET_KEY=${MINIO_SECRET_KEY}
                                            cd chat-admin && ./ci/k8s.sh ${BUILD_NUMBER} ${GIT_BRANCH} ${NAMESPACE} deploy
                                        else
                                            echo "‚ùå chat-admin/ci/k8s.sh file not found in workspace"
                                            echo "üìÅ Current directory contents:"
                                            ls -la
                                            echo "üìÅ chat-admin/ci/ directory contents:"
                                            ls -la chat-admin/ci/ || echo "chat-admin/ci/ directory not found"
                                            exit 1
                                        fi
                                    '''
                                }
                            } catch (Exception e) {
                                error("‚ùå KUBECONFIG credential 'kubeconfig-jenkins' is required but not found in Jenkins. Please configure the credential in Jenkins Credentials Store. Error: ${e.getMessage()}")
                            }
                        } catch (err) {
                            echo "kubectl failed: ${err}"
                            error("Stopping pipeline due to kubectl failure.")
                        }
                    }
                }
            }
        }

    }

    post {
        success {
            echo "‚úÖ Pipeline completed successfully"
        }
        failure {
            echo "‚ùå Pipeline failed"
        }
    }
}

